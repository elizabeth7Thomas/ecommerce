# üìä FLUJO DE DATOS Y L√ìGICA DEL BACKEND

**√öltima actualizaci√≥n:** 12 Noviembre 2025  
**Versi√≥n:** 2.0 - Orientada a L√≥gica de Backend

---

## üéØ FLUJO PRINCIPAL

```
1Ô∏è‚É£ AUTENTICACI√ìN
   ‚îú‚îÄ REGISTRO ‚Üí Usuario nuevo + TOKEN
   ‚îú‚îÄ LOGIN ‚Üí Token de acceso
   ‚îî‚îÄ PERFIL ‚Üí Datos del usuario

2Ô∏è‚É£ COMPRA
   ‚îú‚îÄ VER PRODUCTOS (cat√°logo)
   ‚îú‚îÄ CARRITO (agregar items)
   ‚îú‚îÄ CHECKOUT (crear orden)
   ‚îî‚îÄ PAGO (procesar pago)

3Ô∏è‚É£ SEGUIMIENTO
   ‚îú‚îÄ MIS √ìRDENES (historial)
   ‚îú‚îÄ ESTADO ORDEN (tracking)
   ‚îú‚îÄ ESTADO PAGO (confirmaci√≥n)
   ‚îî‚îÄ MI PERFIL (datos cliente)
```

---

## üîê CONCEPTO CLAVE: AUTENTICACI√ìN CON JWT

### ¬øQU√â ES EL TOKEN?
Un token JWT es como un "pase de acceso" que el backend emite despu√©s del login.

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ TOKEN JWT = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9..."    ‚îÇ
‚îÇ                                         ‚îÇ
‚îÇ Contiene informaci√≥n codificada:        ‚îÇ
‚îÇ ‚Ä¢ Tu ID de usuario                      ‚îÇ
‚îÇ ‚Ä¢ Tu rol (cliente/admin)                ‚îÇ
‚îÇ ‚Ä¢ Tu email                              ‚îÇ
‚îÇ ‚Ä¢ Fecha de expiraci√≥n                   ‚îÇ
‚îÇ ‚Ä¢ Firma del servidor (no se puede       ‚îÇ
‚îÇ   falsificar)                           ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

### ¬øC√ìMO USARLO?
Despu√©s de login/registro, **GUARDA el token** y **ENV√çALO en cada petici√≥n**:

```javascript
// En localStorage (o sessionStorage)
localStorage.setItem('token', response.data.token);

// En CADA petici√≥n autenticada
headers: {
  'Authorization': 'Bearer ' + localStorage.getItem('token')
}
```

---

## üìç ETAPA 1: AUTENTICACI√ìN

### 1.1 REGISTRO - Crear Nueva Cuenta

**¬øQu√© pasa en el backend?**
1. Valida que el email no exista ya
2. Encripta la contrase√±a (nunca se guarda en texto plano)
3. Crea usuario en BD
4. Crea rol "cliente" por defecto
5. Genera TOKEN JWT
6. Retorna token + datos del usuario

**Frontend:**
```javascript
// POST a backend
const response = await fetch('/api/auth/register', {
  method: 'POST',
  headers: { 'Content-Type': 'application/json' },
  body: JSON.stringify({
    nombre_usuario: "juan_perez",
    correo_electronico: "juan@example.com",
    contrasena: "SecurePass123"
  })
});

const data = await response.json();
// Response: { success: true, data: { id_usuario: 5, token: "...", ... } }

// GUARDAR token para futuras peticiones
localStorage.setItem('token', data.data.token);
localStorage.setItem('userId', data.data.id_usuario);
localStorage.setItem('nombre_usuario', data.data.nombre_usuario);
```

---

### 1.2 LOGIN - Iniciar Sesi√≥n

**¬øQu√© pasa en el backend?**
1. Busca usuario por email
2. Valida contrase√±a (compara encriptada)
3. Si es correcto ‚Üí genera TOKEN JWT
4. Retorna token + datos usuario + permisos

**Frontend:**
```javascript
const response = await fetch('/api/auth/login', {
  method: 'POST',
  headers: { 'Content-Type': 'application/json' },
  body: JSON.stringify({
    correo_electronico: "juan@example.com",
    contrasena: "SecurePass123"
  })
});

const data = await response.json();

if (data.success) {
  // GUARDAR token
  localStorage.setItem('token', data.data.token);
  localStorage.setItem('userId', data.data.id_usuario);
  // Redirigir a home/dashboard
  window.location.href = '/dashboard';
} else {
  // Mostrar error: "Email o contrase√±a incorrecta"
  console.error(data.error.message);
}
```

**‚ö†Ô∏è IMPORTANTE:** A partir de aqu√≠, TODAS las peticiones deben incluir el token:
```javascript
headers: {
  'Authorization': 'Bearer ' + localStorage.getItem('token')
}
```

---

### 1.3 OBTENER MI PERFIL

**¬øQu√© pasa en el backend?**
1. Lee token del header
2. Valida que sea v√°lido y no est√© expirado
3. Extrae id_usuario del token
4. Busca usuario en BD
5. Retorna datos del perfil

**Frontend:**
```javascript
const token = localStorage.getItem('token');

const response = await fetch('/api/auth/profile', {
  method: 'GET',
  headers: {
    'Authorization': 'Bearer ' + token
  }
});

const data = await response.json();
// Response: { 
//   data: { 
//     id_usuario: 5, 
//     nombre_usuario: "juan_perez", 
//     correo_electronico: "juan@example.com",
//     rol: { nombre_rol: "cliente", permisos: {...} }
//   } 
// }
```

---

### 1.4 CAMBIAR CONTRASE√ëA

**¬øQu√© pasa en el backend?**
1. Valida token
2. Valida contrase√±a actual (debe coincidir)
3. Encripta la nueva contrase√±a
4. Actualiza en BD
5. No cierra sesi√≥n (token sigue siendo v√°lido)

**Frontend:**
```javascript
const token = localStorage.getItem('token');

const response = await fetch('/api/auth/change-password', {
  method: 'PUT',
  headers: {
    'Content-Type': 'application/json',
    'Authorization': 'Bearer ' + token
  },
  body: JSON.stringify({
    contrasena_actual: "SecurePass123",
    contrasena_nueva: "NuevaSegura456"
  })
});

if (response.ok) {
  alert('Contrase√±a actualizada');
  // Token sigue siendo v√°lido, usuario puede seguir navegando
}
```

---

## üìç ETAPA 2: PERFIL CLIENTE

### ¬øQU√â ES EL PERFIL CLIENTE?
- **Usuario** = Datos de acceso (email, contrase√±a, rol)
- **Cliente** = Datos personales (nombre, apellido, tel√©fono)
- 1 usuario = 1 cliente

**Flujo l√≥gico:**
```
REGISTRO ‚Üí Crea USUARIO ‚Üí Se crea autom√°ticamente un CLIENTE asociado
```

### 2.1 VER MI PERFIL DE CLIENTE

**¬øQu√© pasa en el backend?**
1. Valida token
2. Extrae id_usuario del token
3. Busca cliente asociado a ese usuario
4. Retorna datos del cliente

**Frontend:**
```javascript
const token = localStorage.getItem('token');

const response = await fetch('/api/clientes/perfil', {
  method: 'GET',
  headers: {
    'Authorization': 'Bearer ' + token
  }
});

const data = await response.json();
// Response: {
//   success: true,
//   data: {
//     id_cliente: 3,
//     nombre: "Juan",
//     apellido: "P√©rez",
//     telefono: "555-1234",
//     fecha_registro: "2025-11-05T10:30:00Z"
//   }
// }

console.log(data.data.nombre); // "Juan"
```

### 2.2 ACTUALIZAR PERFIL DE CLIENTE

**¬øQu√© pasa en el backend?**
1. Valida token
2. Encuentra cliente asociado
3. Actualiza solo los campos permitidos
4. Retorna cliente actualizado

**Frontend:**
```javascript
const token = localStorage.getItem('token');

const response = await fetch('/api/clientes/perfil', {
  method: 'PUT',
  headers: {
    'Content-Type': 'application/json',
    'Authorization': 'Bearer ' + token
  },
  body: JSON.stringify({
    nombre: "Juan Carlos",
    apellido: "P√©rez Garc√≠a",
    telefono: "555-9999"
  })
});

const data = await response.json();
// Cliente actualizado
```

---

## üìç ETAPA 3: DIRECCIONES DE ENV√çO

### ¬øPOR QU√â NECESITO DIRECCIONES?
- Puedes tener m√∫ltiples direcciones (casa, trabajo, etc.)
- Al hacer checkout, DEBES elegir a cu√°l direcci√≥n enviar

### 3.1 OBTENER MIS DIRECCIONES

**¬øQu√© pasa en el backend?**
1. Valida token
2. Obtiene id_cliente del usuario
3. Busca TODAS las direcciones de ese cliente
4. Las retorna ordenadas (principal primero)

**Frontend:**
```javascript
const token = localStorage.getItem('token');

const response = await fetch('/api/direcciones', {
  method: 'GET',
  headers: {
    'Authorization': 'Bearer ' + token
  }
});

const data = await response.json();
// Response: {
//   success: true,
//   data: [
//     {
//       id_direccion: 1,
//       calle: "Calle Principal 123",
//       ciudad: "Madrid",
//       codigo_postal: "28001",
//       pais: "Espa√±a",
//       es_principal: true
//     },
//     { ... m√°s direcciones ... }
//   ]
// }

// Usar para llenar dropdown en checkout
data.data.forEach(dir => {
  console.log(`${dir.calle}, ${dir.ciudad}`);
});
```

### 3.2 CREAR NUEVA DIRECCI√ìN

**¬øQu√© pasa en el backend?**
1. Valida token
2. Obtiene id_cliente
3. Valida los datos (formato v√°lido, etc.)
4. Guarda nueva direcci√≥n asociada al cliente
5. Si es_principal = true, desmarca otras direcciones principales

**Frontend:**
```javascript
const response = await fetch('/api/direcciones', {
  method: 'POST',
  headers: {
    'Content-Type': 'application/json',
    'Authorization': 'Bearer ' + localStorage.getItem('token')
  },
  body: JSON.stringify({
    calle: "Avenida Central 456",
    ciudad: "Barcelona",
    codigo_postal: "08002",
    pais: "Espa√±a",
    telefono: "555-7777",
    es_principal: false
  })
});

const data = await response.json();
// Nueva direcci√≥n creada
```

### 3.3 ACTUALIZAR DIRECCI√ìN

**¬øQu√© pasa en el backend?**
1. Valida que la direcci√≥n pertenece al usuario
2. Actualiza campos
3. Retorna direcci√≥n actualizada

**Frontend:**
```javascript
const response = await fetch('/api/direcciones/1', {
  method: 'PUT',
  headers: {
    'Content-Type': 'application/json',
    'Authorization': 'Bearer ' + localStorage.getItem('token')
  },
  body: JSON.stringify({
    telefono: "555-8888",
    es_principal: true  // Marcar como principal
  })
});
```

---

## üìç ETAPA 4: CAT√ÅLOGO DE PRODUCTOS

### ¬øPOR QU√â ESTA ETAPA NO REQUIERE TOKEN?
- Los productos son **p√∫blicos**
- Cualquiera puede ver el cat√°logo (autenticado o no)

### 4.1 LISTAR PRODUCTOS

**¬øQu√© pasa en el backend?**
1. NO requiere autenticaci√≥n
2. Obtiene p√°gina de productos (con paginaci√≥n)
3. Puede filtrar por categor√≠a, precio, etc.
4. Retorna lista con detalles y fotos

**Frontend:**
```javascript
// ‚ö†Ô∏è SIN token - es p√∫blico

// Opci√≥n 1: Ver todos
const response = await fetch('/api/productos');

// Opci√≥n 2: Con filtros
const response = await fetch('/api/productos?categoria=2&minprecio=100&maxprecio=5000');

const data = await response.json();
// Response: {
//   success: true,
//   data: [
//     {
//       id_producto: 1,
//       nombre: "Laptop Gaming",
//       descripcion: "Laptop de alto rendimiento",
//       precio: 1200.00,
//       stock: 5,
//       imagenes: [
//         {
//           id_imagen: 1,
//           url: "https://example.com/img1.jpg",
//           es_principal: true
//         }
//       ],
//       categoria: {
//         id_categoria: 2,
//         nombre_categoria: "Electr√≥nica"
//       }
//     },
//     { ... m√°s productos ... }
//   ]
// }

// Mostrar en tienda
data.data.forEach(producto => {
  console.log(`${producto.nombre} - $${producto.precio}`);
  console.log(`Imagen: ${producto.imagenes[0].url}`);
});
```

### 4.2 VER DETALLES DE UN PRODUCTO

**¬øQu√© pasa en el backend?**
1. Busca producto por ID
2. Carga todas sus im√°genes
3. Retorna detalles completos

**Frontend:**
```javascript
const response = await fetch('/api/productos/1');
const data = await response.json();
// Mostrar detalles completos del producto
```

---

## üìç ETAPA 5: CARRITO DE COMPRAS ‚≠ê

### ¬øQU√â ES EL CARRITO?
- Es temporal (mientras est√©s comprando)
- Cada usuario tiene UN carrito activo
- Contiene items (productos con cantidad)
- Al crear orden, se guarda y se crea un carrito vac√≠o nuevo

### 5.1 OBTENER MI CARRITO

**¬øQu√© pasa en el backend?**
1. Valida token
2. Obtiene id_cliente
3. Busca carrito ACTIVO de ese cliente
4. Carga todos los items con detalles de producto
5. Calcula total

**Frontend:**
```javascript
const token = localStorage.getItem('token');

const response = await fetch('/api/carrito', {
  method: 'GET',
  headers: {
    'Authorization': 'Bearer ' + token
  }
});

const data = await response.json();
// Response: {
//   success: true,
//   data: {
//     id_carrito: 5,
//     estado: "activo",
//     items: [
//       {
//         id_carrito_producto: 10,
//         id_producto: 1,
//         nombre_producto: "Laptop Gaming",
//         cantidad: 2,
//         precio_unitario: 1200.00,
//         subtotal: 2400.00  // cantidad √ó precio
//       },
//       { ... m√°s items ... }
//     ],
//     total: 2400.00
//   }
// }

// Mostrar en p√°gina
console.log(`Carrito: ${data.data.items.length} items`);
console.log(`Total: $${data.data.total}`);
```

### 5.2 AGREGAR PRODUCTO AL CARRITO

**¬øQu√© pasa en el backend?**
1. Valida token
2. Obtiene id_cliente
3. Busca carrito activo (o crea uno si no existe)
4. **Valida que el producto existe y tiene stock**
5. Busca si el producto ya estaba en carrito
   - Si S√ç ‚Üí aumenta cantidad
   - Si NO ‚Üí agrega nuevo item
6. Recalcula total
7. Retorna carrito actualizado

**Frontend:**
```javascript
const response = await fetch('/api/carrito', {
  method: 'POST',
  headers: {
    'Content-Type': 'application/json',
    'Authorization': 'Bearer ' + localStorage.getItem('token')
  },
  body: JSON.stringify({
    id_producto: 1,
    cantidad: 2
  })
});

const data = await response.json();

if (data.success) {
  console.log('Producto agregado');
  console.log(`Carrito ahora tiene: $${data.data.total}`);
} else {
  // Error: "Sin stock" o "Producto no existe"
  console.error(data.error.message);
}
```

### 5.3 ACTUALIZAR CANTIDAD EN CARRITO

**¬øQu√© pasa en el backend?**
1. Valida token
2. Busca producto en carrito del usuario
3. **Valida nueva cantidad <= stock disponible**
4. Actualiza cantidad
5. Recalcula total

**Frontend:**
```javascript
// Cambiar cantidad de laptop a 5 unidades
const response = await fetch('/api/carrito/1', {  // id_producto = 1
  method: 'PUT',
  headers: {
    'Content-Type': 'application/json',
    'Authorization': 'Bearer ' + localStorage.getItem('token')
  },
  body: JSON.stringify({
    cantidad: 5
  })
});

const data = await response.json();
// Carrito actualizado con nueva cantidad y total
```

### 5.4 ELIMINAR PRODUCTO DEL CARRITO

**¬øQu√© pasa en el backend?**
1. Valida token
2. Busca producto en carrito
3. Lo elimina
4. Recalcula total

**Frontend:**
```javascript
const response = await fetch('/api/carrito/1', {  // id_producto = 1
  method: 'DELETE',
  headers: {
    'Authorization': 'Bearer ' + localStorage.getItem('token')
  }
});

if (response.ok) {
  console.log('Producto removido del carrito');
}
```

### 5.5 VACIAR CARRITO

**¬øQu√© pasa en el backend?**
1. Valida token
2. Elimina TODOS los items del carrito
3. El carrito queda vac√≠o pero sigue activo

**Frontend:**
```javascript
const response = await fetch('/api/carrito/clear', {
  method: 'DELETE',
  headers: {
    'Authorization': 'Bearer ' + localStorage.getItem('token')
  }
});
```

---

## üìç ETAPA 6: CREAR ORDEN (CHECKOUT)

### ¬øQU√â PASA AL HACER CHECKOUT?
El backend convierte los items del carrito en una ORDEN guardada permanentemente.

```
CARRITO (temporal)
    ‚Üì (checkout)
ORDEN (permanente + items guardados)
    ‚Üì
Carrito se vac√≠a (nuevo carrito activo creado)
```

### 6.1 CREAR ORDEN DESDE CARRITO

**¬øQu√© pasa en el backend?** ‚ö†Ô∏è PROCESO CR√çTICO
1. Valida token
2. Obtiene id_cliente
3. Obtiene carrito activo
   - Si est√° vac√≠o ‚Üí ERROR
4. Valida la direcci√≥n enviada:
   - Debe existir
   - Debe pertenecer al usuario
5. **Verificaci√≥n de stock (IMPORTANTE):**
   - Para CADA item, revisa stock actual
   - Si alguno no tiene suficiente ‚Üí ERROR (rollback)
6. **SI TODO OK - INICIA TRANSACCI√ìN:**
   - Decrementa stock de cada producto
   - Crea ORDEN
   - Crea ORDEN_ITEMS (copia de items del carrito)
   - Marca carrito como "completado"
   - Crea carrito nuevo y activo
7. Retorna orden creada

**Frontend:**
```javascript
// Antes de hacer click en "Comprar", asegurate de:
// 1. Carrito no est√© vac√≠o
// 2. Usuario tenga direcciones
// 3. Usuario haya seleccionado direcci√≥n de env√≠o

const directionId = 1; // ID seleccionado por usuario

const response = await fetch('/api/ordenes', {
  method: 'POST',
  headers: {
    'Content-Type': 'application/json',
    'Authorization': 'Bearer ' + localStorage.getItem('token')
  },
  body: JSON.stringify({
    id_direccion: directionId,
    notas: "Enviar entre 10am y 6pm"  // Opcional
  })
});

const data = await response.json();

if (data.success) {
  console.log('Orden creada:', data.data);
  // Response: {
  //   id_orden: 15,
  //   numero_orden: "ORD-2025-00015",  // N√∫mero √∫nico
  //   estado_orden: "pendiente",       // Esperando pago
  //   total: 2400.00,
  //   items: [ ... ],                  // Copias de los items
  //   fecha_creacion: "2025-11-12..."
  // }
  
  // GUARDAR id_orden para siguiente paso (pago)
  localStorage.setItem('ordenId', data.data.id_orden);
  
  // Redirigir a p√°gina de pago
  window.location.href = '/checkout/pago';
} else {
  // Errores comunes:
  // - "Carrito vac√≠o"
  // - "Direcci√≥n no encontrada"
  // - "Sin stock de producto X"
  console.error(data.error.message);
}
```

### 6.2 VER MIS √ìRDENES

**¬øQu√© pasa en el backend?**
1. Valida token
2. Obtiene id_cliente
3. Busca TODAS las √≥rdenes del cliente
4. Retorna lista con estado, total, fecha

**Frontend:**
```javascript
const response = await fetch('/api/ordenes', {
  method: 'GET',
  headers: {
    'Authorization': 'Bearer ' + localStorage.getItem('token')
  }
});

const data = await response.json();
// Response: {
//   data: [
//     {
//       id_orden: 15,
//       numero_orden: "ORD-2025-00015",
//       estado_orden: "completada",
//       total: 2400.00,
//       fecha_creacion: "2025-11-12T10:30:00Z"
//     },
//     { ... m√°s √≥rdenes ... }
//   ]
// }

// Mostrar historial
data.data.forEach(orden => {
  console.log(`${orden.numero_orden} - $${orden.total} - ${orden.estado_orden}`);
});
```

### 6.3 VER DETALLES DE UNA ORDEN

**¬øQu√© pasa en el backend?**
1. Valida token
2. Busca orden por ID
3. Verifica que pertenece al usuario
4. Carga todos los items
5. Carga direcci√≥n de env√≠o
6. Carga pagos asociados

**Frontend:**
```javascript
const ordenId = localStorage.getItem('ordenId');  // De paso anterior

const response = await fetch(`/api/ordenes/${ordenId}`, {
  method: 'GET',
  headers: {
    'Authorization': 'Bearer ' + localStorage.getItem('token')
  }
});

const data = await response.json();
// Response: {
//   success: true,
//   data: {
//     id_orden: 15,
//     numero_orden: "ORD-2025-00015",
//     estado_orden: "pendiente",  // Esperando pago
//     items: [
//       {
//         id_item: 20,
//         nombre_producto: "Laptop Gaming",
//         cantidad: 2,
//         precio_unitario: 1200.00,
//         subtotal: 2400.00
//       }
//     ],
//     direccion_envio: {
//       calle: "Calle Principal 123",
//       ciudad: "Madrid",
//       codigo_postal: "28001"
//     },
//     pagos: [
//       {
//         id_pago: 8,
//         monto: 2400.00,
//         metodo_pago: "tarjeta_credito",
//         estado_pago: "completado",  // ‚úÖ Pago hecho
//         fecha: "2025-11-12T11:00:00Z"
//       }
//     ],
//     total: 2400.00
//   }
// }

// Mostrar estado
console.log(`Orden #${data.data.numero_orden}`);
console.log(`Estado: ${data.data.estado_orden}`);
console.log(`Pagos: ${data.data.pagos.length}`);
```

---

## üìç ETAPA 7: PROCESAMIENTO DE PAGOS

### ¬øQU√â SIGNIFICA CADA ESTADO DE PAGO?

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ ORDEN CREADA (estado: pendiente)   ‚îÇ
‚îÇ - Items guardados                  ‚îÇ
‚îÇ - Stock decrementado               ‚îÇ
‚îÇ - Esperando pago                   ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
         ‚Üì
         ‚îÇ Usuario hace pago
         ‚Üì
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ PAGO CREADO (estado: completado)   ‚îÇ
‚îÇ - Dinero confirmado                ‚îÇ
‚îÇ - Orden ‚Üí estado: confirmada       ‚îÇ
‚îÇ - Env√≠o puede procesarse           ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
         ‚Üì
         ‚îÇ Admin prepara env√≠o
         ‚Üì
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ ORDEN ENVIADA               ‚îÇ
‚îÇ - Usuario recibe tracking   ‚îÇ
‚îÇ - Esperando entrega         ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
         ‚Üì
         ‚îÇ Llega a destino
         ‚Üì
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ ORDEN COMPLETADA            ‚îÇ
‚îÇ - Usuario la recibi√≥        ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

### 7.1 CREAR PAGO PARA UNA ORDEN

**¬øQu√© pasa en el backend?** ‚ö†Ô∏è IMPORTANTE
1. Valida token
2. Busca orden por ID
3. Verifica que pertenece al usuario
4. **Valida:**
   - Orden existe
   - Monto = total de la orden
   - Estado orden es "pendiente"
5. Crea PAGO con estado "completado"
6. **Cambia estado orden a "confirmada"**
7. Retorna pago creado

**Frontend:**
```javascript
const ordenId = localStorage.getItem('ordenId');
const token = localStorage.getItem('token');

// Obtener total de la orden primero
const ordenResponse = await fetch(`/api/ordenes/${ordenId}`, {
  headers: { 'Authorization': 'Bearer ' + token }
});
const orden = await ordenResponse.json();
const montoTotal = orden.data.total;

// Crear pago
const response = await fetch(`/api/ordenes/${ordenId}/pagos`, {
  method: 'POST',
  headers: {
    'Content-Type': 'application/json',
    'Authorization': 'Bearer ' + token
  },
  body: JSON.stringify({
    monto: montoTotal,
    metodo_pago: "tarjeta_credito",  // o "transferencia", "efectivo"
    referencia_pago: "TXN-123456789"  // Tu referencia
  })
});

const data = await response.json();

if (data.success) {
  console.log('Pago creado exitosamente');
  // Response: {
  //   id_pago: 8,
  //   monto: 2400.00,
  //   metodo_pago: "tarjeta_credito",
  //   estado_pago: "completado",
  //   fecha_creacion: "2025-11-12T11:00:00Z"
  // }
  
  // La orden ahora est√° confirmada y lista para env√≠o
  alert('¬°Pago completado! Tu orden est√° confirmada.');
  
  // Redirigir a mis √≥rdenes
  window.location.href = '/mis-ordenes';
} else {
  console.error('Error:', data.error.message);
}
```

### 7.2 VER PAGOS DE UNA ORDEN

**¬øQu√© pasa en el backend?**
1. Valida token y que orden pertenece al usuario
2. Obtiene TODOS los pagos de esa orden
3. Retorna lista de pagos

**Frontend:**
```javascript
const ordenId = 15;

const response = await fetch(`/api/ordenes/${ordenId}/pagos`, {
  method: 'GET',
  headers: {
    'Authorization': 'Bearer ' + localStorage.getItem('token')
  }
});

const data = await response.json();
// Response: {
//   data: [
//     {
//       id_pago: 8,
//       monto: 2400.00,
//       metodo_pago: "tarjeta_credito",
//       estado_pago: "completado",
//       fecha_creacion: "2025-11-12T11:00:00Z"
//     }
//   ]
// }
```

---

## üìä RELACIONES ENTRE TABLAS

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  USUARIOS   ‚îÇ (email, contrase√±a, rol)
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
       ‚îÇ 1:1 (relaci√≥n directa)
       ‚îÇ
       ‚Üì
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  CLIENTES   ‚îÇ (nombre, apellido, tel√©fono)
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
       ‚îÇ 1:‚àû (un cliente, m√∫ltiples direcciones/carritos/√≥rdenes)
       ‚îÇ
       ‚îú‚îÄ‚Üí DIRECCIONES (env√≠o)
       ‚îú‚îÄ‚Üí CARRITO (temporal, mientras compra)
       ‚îÇ   ‚îî‚îÄ‚Üí CARRITO_ITEMS (productos en carrito)
       ‚îÇ
       ‚îî‚îÄ‚Üí √ìRDENES (permanentes)
           ‚îú‚îÄ‚Üí ORDEN_ITEMS (productos que compr√≥)
           ‚îú‚îÄ‚Üí PAGOS (puede tener m√∫ltiples pagos)
           ‚îî‚îÄ‚Üí DIRECCION_ENVIO (a d√≥nde ir)

‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  PRODUCTOS  ‚îÇ (nombre, precio, stock)
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
       ‚îÇ 1:‚àû (un producto en m√∫ltiples √≥rdenes)
       ‚îÇ
       ‚îú‚îÄ‚Üí IMAGENES (fotos del producto)
       ‚îú‚îÄ‚Üí CATEGORIAS (electr√≥nica, ropa, etc.)
       ‚îî‚îÄ‚Üí INVENTARIO (stock en almacenes)
```

---

## üîë CONCEPTOS CLAVE PARA EL FRONTEND

### 1Ô∏è‚É£ TOKEN JWT
- **Qu√© es:** Credencial de autenticaci√≥n (texto encriptado)
- **D√≥nde guardarlo:** `localStorage.setItem('token', ...)`
- **Cu√°ndo usarlo:** En TODOS los request autenticados
- **C√≥mo usarlo:** `headers: { 'Authorization': 'Bearer ' + token }`
- **Expiraci√≥n:** El servidor valida cada vez (si est√° expirado, pide nuevo login)

### 2Ô∏è‚É£ ID_CLIENTE
- **Generado autom√°ticamente** cuando te registras
- **NO lo env√≠as en requests** (se extrae del token)
- **Lo obtienes** del endpoint `/api/clientes/perfil`

### 3Ô∏è‚É£ TRANSACCIONES (importante en √≥rdenes)
Si alg√∫n paso falla en CREAR ORDEN, **TODO se revierte**:
- No se decrementa stock
- No se crea orden
- No se vac√≠a carrito
- Carrito queda como estaba

Esto garantiza que **NO puedas** tener una orden sin stock o carrito sin dinero.

### 4Ô∏è‚É£ ESTADO DE ORDEN
```
pendiente ‚Üí confirmada ‚Üí enviada ‚Üí completada ‚Üí (cancelada)
```

### 5Ô∏è‚É£ ESTADO DE PAGO
```
pendiente ‚Üí completado ‚Üí (cancelado)
```

### 6Ô∏è‚É£ CARRITO
- **Temporal** mientras compres
- **1 carrito activo** por usuario a la vez
- **Al checkout** ‚Üí se archiva ‚Üí se crea uno nuevo

---

## ‚ö†Ô∏è ERRORES COMUNES Y C√ìMO EVITARLOS

| Error | Causa | Soluci√≥n |
|-------|-------|----------|
| "Unauthorized" (401) | Token expirado o falta header | Validar token guardado, hacer login nuevo |
| "Token inv√°lido" | Token corrupto | Limpiar localStorage y login nuevo |
| "Carrito vac√≠o" | Intenta crear orden sin items | Agregar productos al carrito primero |
| "Sin stock" | No hay cantidad suficiente | Verificar stock antes o reducir cantidad |
| "Direcci√≥n no encontrada" | ID direcci√≥n incorrecto o no es tuya | Obtener IDs de GET /api/direcciones primero |
| "Monto no coincide" | Pago ‚â† total de orden | Usar el monto exacto de la orden |
| 404 Not Found | Endpoint incorrecto | Verificar ruta exacta del API |
| 500 Internal Error | Error del servidor | Revisar logs del backend |

---

## üìù TABLA DE REFERENCIA R√ÅPIDA

| Endpoint | M√©todo | Token | Funci√≥n |
|----------|--------|-------|---------|
| `/api/auth/register` | POST | ‚ùå | Crear cuenta |
| `/api/auth/login` | POST | ‚ùå | Iniciar sesi√≥n |
| `/api/auth/profile` | GET | ‚úÖ | Ver perfil usuario |
| `/api/clientes/perfil` | GET | ‚úÖ | Ver perfil cliente |
| `/api/clientes/perfil` | PUT | ‚úÖ | Editar perfil |
| `/api/direcciones` | GET | ‚úÖ | Ver direcciones |
| `/api/direcciones` | POST | ‚úÖ | Crear direcci√≥n |
| `/api/direcciones/:id` | PUT | ‚úÖ | Editar direcci√≥n |
| `/api/direcciones/:id` | DELETE | ‚úÖ | Eliminar direcci√≥n |
| `/api/productos` | GET | ‚ùå | Ver cat√°logo |
| `/api/productos/:id` | GET | ‚ùå | Ver producto |
| `/api/categorias` | GET | ‚ùå | Ver categor√≠as |
| `/api/carrito` | GET | ‚úÖ | Ver carrito |
| `/api/carrito` | POST | ‚úÖ | Agregar al carrito |
| `/api/carrito/:id` | PUT | ‚úÖ | Cambiar cantidad |
| `/api/carrito/:id` | DELETE | ‚úÖ | Quitar del carrito |
| `/api/carrito/clear` | DELETE | ‚úÖ | Vaciar carrito |
| `/api/ordenes` | GET | ‚úÖ | Ver mis √≥rdenes |
| `/api/ordenes` | POST | ‚úÖ | **CREAR ORDEN** |
| `/api/ordenes/:id` | GET | ‚úÖ | Ver detalles orden |
| `/api/ordenes/:id/pagos` | GET | ‚úÖ | Ver pagos |
| `/api/ordenes/:id/pagos` | POST | ‚úÖ | **CREAR PAGO** |

---

## üéØ CHECKLIST: COMPRA PASO A PASO

- [ ] Usuario se registra/login y recibe token
- [ ] Frontend guarda token en localStorage
- [ ] Usuario ve cat√°logo (sin token)
- [ ] Usuario agrega productos al carrito (con token)
- [ ] Usuario verifica carrito
- [ ] Usuario selecciona direcci√≥n de env√≠o
- [ ] Frontend crea ORDEN (POST /api/ordenes)
- [ ] Backend valida stock y crea orden
- [ ] Frontend obtiene id_orden
- [ ] Usuario procesa pago
- [ ] Frontend crea PAGO (POST /api/ordenes/{id}/pagos)
- [ ] Orden cambia a estado "confirmada"
- [ ] Usuario ve confirmaci√≥n

---

**√öltima actualizaci√≥n:** 12 Noviembre 2025  
**Version:** 2.0 - Orientada a L√≥gica de Backend

---

## ÔøΩ FLUJOS DETALLADOS DE CADA CONTROLADOR

### FLUJO 1: AuthController (Autenticaci√≥n)
```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ   USUARIO   ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
       ‚îÇ Inicia registro/login
       ‚Üì
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ   AuthController         ‚îÇ
‚îÇ ‚Ä¢ register()             ‚îÇ
‚îÇ ‚Ä¢ login()                ‚îÇ
‚îÇ ‚Ä¢ getProfile()           ‚îÇ
‚îÇ ‚Ä¢ updateProfile()        ‚îÇ
‚îÇ ‚Ä¢ changePassword()       ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
           ‚îÇ Valida datos y llama service
           ‚Üì
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ   UserService            ‚îÇ
‚îÇ ‚Ä¢ createUser()           ‚îÇ
‚îÇ ‚Ä¢ getUserById()          ‚îÇ
‚îÇ ‚Ä¢ getUserByEmail()       ‚îÇ
‚îÇ ‚Ä¢ updateUser()           ‚îÇ
‚îÇ ‚Ä¢ disableUser()          ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
           ‚îÇ Ejecuta queries SQL
           ‚Üì
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ   BD (PostgreSQL)        ‚îÇ
‚îÇ   Tabla: Usuarios        ‚îÇ
‚îÇ   Tabla: Roles           ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
           ‚îÇ Retorna datos
           ‚Üë
       [TOKEN JWT]
   (Guardado en localStorage)
```

**Pasos clave:**
1. Frontend env√≠a credenciales
2. Controller valida formato
3. Service busca/crea usuario en BD
4. Se genera JWT si es √©xito
5. Frontend guarda token para futuras requests

---

### FLUJO 2: ClienteController (Gesti√≥n de Perfil Cliente)
```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ   USUARIO   ‚îÇ (Autenticado con token)
‚îÇ (Token)     ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
       ‚îÇ GET/POST/PUT /api/clientes
       ‚Üì
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ   ClienteController      ‚îÇ
‚îÇ ‚Ä¢ getPerfil()            ‚îÇ
‚îÇ ‚Ä¢ crearPerfil()          ‚îÇ
‚îÇ ‚Ä¢ actualizarPerfil()     ‚îÇ
‚îÇ ‚Ä¢ obtenerCliente()       ‚îÇ (solo admin)
‚îÇ ‚Ä¢ eliminarCliente()      ‚îÇ (solo admin)
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
           ‚îÇ Valida token + permisos
           ‚îÇ Llama service
           ‚Üì
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ   ClienteService         ‚îÇ
‚îÇ ‚Ä¢ getClientByUserId()    ‚îÇ
‚îÇ ‚Ä¢ createClient()         ‚îÇ
‚îÇ ‚Ä¢ updateClient()         ‚îÇ
‚îÇ ‚Ä¢ deleteClient()         ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
           ‚îÇ Ejecuta queries SQL
           ‚Üì
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ   BD (PostgreSQL)        ‚îÇ
‚îÇ   Tabla: Clientes        ‚îÇ
‚îÇ   Tabla: Usuarios        ‚îÇ (relaci√≥n 1:1)
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
           ‚îÇ Retorna datos cliente
           ‚Üë
      Respuesta JSON
```

**Flujo espec√≠fico GET /api/clientes/perfil:**
1. Middleware verifica token ‚Üí extrae id_usuario
2. ClienteController llama service
3. Service busca cliente donde id_usuario = {id_usuario}
4. Retorna perfil del cliente (nombre, apellido, tel√©fono, etc.)

---

### FLUJO 3: ProductoController (Cat√°logo de Productos)
```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ   USUARIO   ‚îÇ (No requiere autenticaci√≥n para listar)
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
       ‚îÇ GET /api/productos
       ‚îÇ GET /api/productos/:id
       ‚Üì
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ   ProductoController     ‚îÇ
‚îÇ ‚Ä¢ listarProductos()      ‚îÇ (p√∫blico)
‚îÇ ‚Ä¢ obtenerProducto()      ‚îÇ (p√∫blico)
‚îÇ ‚Ä¢ crearProducto()        ‚îÇ (solo admin)
‚îÇ ‚Ä¢ actualizarProducto()   ‚îÇ (solo admin)
‚îÇ ‚Ä¢ eliminarProducto()     ‚îÇ (solo admin)
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
           ‚îÇ Valida (permisos si es POST/PUT/DELETE)
           ‚îÇ Llama service
           ‚Üì
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ   ProductoService        ‚îÇ
‚îÇ ‚Ä¢ getAll()               ‚îÇ
‚îÇ ‚Ä¢ getById()              ‚îÇ
‚îÇ ‚Ä¢ create()               ‚îÇ
‚îÇ ‚Ä¢ update()               ‚îÇ
‚îÇ ‚Ä¢ delete()               ‚îÇ
‚îÇ ‚Ä¢ getByCategory()        ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
           ‚îÇ Ejecuta queries SQL
           ‚Üì
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ   BD (PostgreSQL)        ‚îÇ
‚îÇ   Tabla: Productos       ‚îÇ
‚îÇ   Tabla: Categorias      ‚îÇ (FK)
‚îÇ   Tabla: ProductoImagenes‚îÇ (1:N)
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
           ‚îÇ Retorna array de productos
           ‚Üë
      Respuesta JSON
```

**Ejemplo GET /api/productos?categoria=2&minprecio=100&maxprecio=5000:**
1. No necesita token
2. Controller recibe query params
3. Service construye WHERE con filtros
4. BD retorna productos que coincidan

---

### FLUJO 4: CarritoController (Carrito de Compras) ‚≠ê
```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ   USUARIO   ‚îÇ (REQUIERE AUTENTICACI√ìN)
‚îÇ (Token)     ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
       ‚îÇ GET /api/carrito (ver carrito)
       ‚îÇ POST /api/carrito (agregar producto)
       ‚îÇ PUT /api/carrito/:id_producto (cambiar cantidad)
       ‚îÇ DELETE /api/carrito/:id_producto (quitar)
       ‚Üì
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ   CarritoController      ‚îÇ
‚îÇ ‚Ä¢ obtenerCarrito()       ‚îÇ
‚îÇ ‚Ä¢ agregarProducto()      ‚îÇ
‚îÇ ‚Ä¢ actualizarCantidad()   ‚îÇ
‚îÇ ‚Ä¢ eliminarProducto()     ‚îÇ
‚îÇ ‚Ä¢ vaciarCarrito()        ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
           ‚îÇ Valida token ‚Üí obtiene id_usuario
           ‚îÇ Llama service
           ‚Üì
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ   ClienteService         ‚îÇ
‚îÇ ‚Ä¢ getClientByUserId()    ‚îÇ (obtiene id_cliente)
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
           ‚îÇ
           ‚Üì
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ   CarritoService         ‚îÇ
‚îÇ ‚Ä¢ obtenerCarritoActivo() ‚îÇ
‚îÇ ‚Ä¢ agregarProducto()      ‚îÇ
‚îÇ ‚Ä¢ actualizarCantidad()   ‚îÇ
‚îÇ ‚Ä¢ eliminarProducto()     ‚îÇ
‚îÇ ‚Ä¢ calcularTotal()        ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
           ‚îÇ Valida:
           ‚îÇ - Producto existe
           ‚îÇ - Stock disponible
           ‚îÇ - Carrito existe o crear nuevo
           ‚Üì
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ   BD (PostgreSQL)        ‚îÇ
‚îÇ   Tabla: CarritoCompras  ‚îÇ
‚îÇ   Tabla: CarritoProductos‚îÇ
‚îÇ   Tabla: Productos       ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
           ‚îÇ Retorna carrito actualizado
           ‚Üë
      Respuesta JSON con:
      - ID carrito
      - Lista de items
      - Subtotal de cada item
      - Total carrito
```

**Ejemplo POST /api/carrito (agregar producto):**
```
USUARIO ‚Üí Controller recibe {id_producto: 5, cantidad: 2}
        ‚Üí Valida token (obtiene id_usuario)
        ‚Üí Llama ClienteService.getClientByUserId(id_usuario)
        ‚Üí Obtiene id_cliente
        ‚Üí Llama CarritoService.obtenerCarritoActivo(id_cliente)
        ‚Üí Si no existe carrito ‚Üí crea uno nuevo
        ‚Üí Valida stock: ProductoService.verificarStock(id_producto, 2)
        ‚Üí Si stock OK ‚Üí agrega a tabla CarritoProductos
        ‚Üí Calcula total
        ‚Üí Retorna carrito actualizado
```

**Estados del carrito:**
- `activo` ‚Üí usuario a√∫n est√° comprando
- `completado` ‚Üí orden creada, carrito archivado

---

### FLUJO 5: DireccionController (Direcciones de Env√≠o)
```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ   USUARIO   ‚îÇ (REQUIERE AUTENTICACI√ìN)
‚îÇ (Token)     ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
       ‚îÇ GET /api/direcciones
       ‚îÇ POST /api/direcciones (crear nueva)
       ‚îÇ PUT /api/direcciones/:id (editar)
       ‚îÇ DELETE /api/direcciones/:id (borrar)
       ‚Üì
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ   DireccionController    ‚îÇ
‚îÇ ‚Ä¢ listarDirecciones()    ‚îÇ
‚îÇ ‚Ä¢ crearDireccion()       ‚îÇ
‚îÇ ‚Ä¢ actualizarDireccion()  ‚îÇ
‚îÇ ‚Ä¢ eliminarDireccion()    ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
           ‚îÇ Valida token ‚Üí obtiene id_usuario
           ‚îÇ Busca id_cliente
           ‚îÇ Llama service
           ‚Üì
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ   DireccionService       ‚îÇ
‚îÇ ‚Ä¢ getByCliente()         ‚îÇ
‚îÇ ‚Ä¢ create()               ‚îÇ
‚îÇ ‚Ä¢ update()               ‚îÇ
‚îÇ ‚Ä¢ delete()               ‚îÇ
‚îÇ ‚Ä¢ setMasPrincipal()      ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
           ‚îÇ Valida:
           ‚îÇ - Datos direcci√≥n v√°lidos
           ‚îÇ - Solo propias direcciones
           ‚Üì
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ   BD (PostgreSQL)        ‚îÇ
‚îÇ   Tabla: Direcciones     ‚îÇ
‚îÇ   Tabla: Clientes        ‚îÇ (FK)
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
           ‚îÇ Retorna direcci√≥n/s
           ‚Üë
      Respuesta JSON
```

**Datos de una direcci√≥n:**
- Calle, n√∫mero, apartamento
- Ciudad, c√≥digo postal
- Pa√≠s
- Tel√©fono (opcional)
- Es principal (boolean)

---

### FLUJO 6: OrdenController (Crear √ìrdenes)
```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ   USUARIO   ‚îÇ (REQUIERE AUTENTICACI√ìN)
‚îÇ (Token)     ‚îÇ (Tiene carrito con items)
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
       ‚îÇ POST /api/ordenes
       ‚îÇ {id_direccion: 1, notas: "..."}
       ‚Üì
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ   OrdenController        ‚îÇ
‚îÇ ‚Ä¢ crearOrden()           ‚îÇ
‚îÇ ‚Ä¢ listarOrdenes()        ‚îÇ
‚îÇ ‚Ä¢ obtenerOrden()         ‚îÇ
‚îÇ ‚Ä¢ actualizarEstado()     ‚îÇ (solo admin)
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
           ‚îÇ Valida token ‚Üí id_usuario
           ‚îÇ Inicia TRANSACCI√ìN
           ‚Üì
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ   ClienteService         ‚îÇ
‚îÇ ‚Ä¢ getClientByUserId()    ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
           ‚îÇ Obtiene id_cliente
           ‚Üì
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ   CarritoService         ‚îÇ
‚îÇ ‚Ä¢ obtenerCarritoActivo() ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
           ‚îÇ Obtiene items en carrito
           ‚Üì
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ   DireccionService       ‚îÇ
‚îÇ ‚Ä¢ getDireccionById()     ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
           ‚îÇ Valida direcci√≥n existe y pertenece al usuario
           ‚Üì
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ   OrdenService           ‚îÇ
‚îÇ ‚Ä¢ create()               ‚îÇ
‚îÇ ‚Ä¢ createItems()          ‚îÇ
‚îÇ ‚Ä¢ calcularTotal()        ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
           ‚îÇ Para cada item:
           ‚îÇ 1. Verifica stock actual
           ‚îÇ 2. Descuenta stock
           ‚îÇ 3. Crea orden_item
           ‚îÇ 4. Calcula subtotal
           ‚Üì
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ   BD (PostgreSQL)        ‚îÇ
‚îÇ   Tabla: Ordenes         ‚îÇ
‚îÇ   Tabla: OrdenItems      ‚îÇ
‚îÇ   Tabla: Productos       ‚îÇ
‚îÇ   (Stock se actualiza)   ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
           ‚îÇ Marca carrito como "completado"
           ‚îÇ Confirma TRANSACCI√ìN
           ‚Üë
      Respuesta JSON:
      - numero_orden (ej: ORD-2025-00015)
      - items de la orden
      - total
      - estado: "pendiente"
```

**Validaciones cr√≠ticas:**
1. ‚úÖ Usuario autenticado
2. ‚úÖ Carrito no vac√≠o
3. ‚úÖ Direcci√≥n existe y pertenece al usuario
4. ‚úÖ Stock suficiente para TODOS los items
5. ‚úÖ Si falla algo ‚Üí ROLLBACK (no se crea nada)

---

### FLUJO 7: PaymentController (Procesamiento de Pagos)
```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ   USUARIO   ‚îÇ (REQUIERE AUTENTICACI√ìN)
‚îÇ (Token)     ‚îÇ (Tiene orden con estado "pendiente")
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
       ‚îÇ POST /api/ordenes/:id_orden/pagos
       ‚îÇ {monto, metodo_pago, referencia_pago}
       ‚Üì
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ   PaymentController      ‚îÇ
‚îÇ ‚Ä¢ crearPago()            ‚îÇ
‚îÇ ‚Ä¢ listarPagos()          ‚îÇ
‚îÇ ‚Ä¢ obtenerPago()          ‚îÇ
‚îÇ ‚Ä¢ actualizarEstado()     ‚îÇ (solo admin)
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
           ‚îÇ Valida token
           ‚îÇ Inicia TRANSACCI√ìN
           ‚Üì
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ   OrdenService           ‚îÇ
‚îÇ ‚Ä¢ getOrdenById()         ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
           ‚îÇ Valida:
           ‚îÇ - Orden existe
           ‚îÇ - Pertenece al usuario
           ‚îÇ - Estado es "pendiente"
           ‚Üì
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ   PaymentService         ‚îÇ
‚îÇ ‚Ä¢ create()               ‚îÇ
‚îÇ ‚Ä¢ validarMonto()         ‚îÇ
‚îÇ ‚Ä¢ procesarPago()         ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
           ‚îÇ Valida:
           ‚îÇ 1. Monto = total orden
           ‚îÇ 2. M√©todo pago v√°lido
           ‚îÇ 3. Integraci√≥n con gateway (si existe)
           ‚Üì
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ   BD (PostgreSQL)        ‚îÇ
‚îÇ   Tabla: Pagos           ‚îÇ
‚îÇ   Tabla: Ordenes         ‚îÇ
‚îÇ   (Estado se actualiza)  ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
           ‚îÇ Crea pago con estado "completado"
           ‚îÇ Actualiza estado orden a "confirmada"
           ‚îÇ Confirma TRANSACCI√ìN
           ‚Üë
      Respuesta JSON:
      - id_pago
      - monto confirmado
      - metodo_pago
      - estado: "completado"
      - fecha pago
```

**M√©todos de pago soportados:**
- `tarjeta_credito` ‚Üí integraci√≥n con gateway (futuro)
- `transferencia` ‚Üí validaci√≥n manual
- `efectivo` ‚Üí requiere confirmaci√≥n admin

**Estados del pago:**
- `pendiente` ‚Üí creado pero no confirmado
- `completado` ‚Üí pago exitoso
- `cancelado` ‚Üí pago rechazado

---

## ÔøΩüí° TIPS PARA EL FRONTEND

1. **Guardar token despu√©s de login:**
   ```javascript
   localStorage.setItem('token', response.data.token);
   ```

2. **Usar token en todas las peticiones autenticadas:**
   ```javascript
   headers: { "Authorization": `Bearer ${localStorage.getItem('token')}` }
   ```

3. **Validar stock antes de comprar:**
   - Verificar `producto.stock > 0` antes de agregar al carrito

4. **Mostrar total del carrito:**
   - Sumar: `item.cantidad * item.precio_unitario` para cada item

5. **Estados de orden:** pendiente ‚Üí confirmada ‚Üí enviada ‚Üí completada

6. **Estados de pago:** pendiente ‚Üí completado ‚Üí cancelado

---

## üìç RESUMEN - QU√â HACE CADA CONTROLADOR

| Controlador | Funci√≥n Principal | Requiere Auth |
|---|---|---|
| **AuthController** | Registro, Login, Perfil, Cambio Password | Parcial |
| **ClienteController** | Gestionar perfil cliente (asociado a usuario) | ‚úÖ S√≠ |
| **ProductoController** | CRUD productos (admin) y listar (todos) | Parcial |
| **CarritoController** | Agregar/remover productos, ver carrito | ‚úÖ S√≠ |
| **DireccionController** | Gestionar direcciones de env√≠o | ‚úÖ S√≠ |
| **OrdenController** | Crear √≥rdenes desde carrito, ver mis √≥rdenes | ‚úÖ S√≠ |
| **PaymentController** | Procesar pagos, actualizar estados | ‚úÖ S√≠ |

---