# ğŸ“Š FLUJO DE DATOS - DOCUMENTACIÃ“N PARA FRONTEND

## ğŸ¯ FLUJO PRINCIPAL DE LA APLICACIÃ“N
```
[INICIO] â†’ [REGISTRO] â†’ [LOGIN] â†’ [VER PRODUCTOS] â†’ [CARRITO] â†’ [CHECKOUT] â†’ [PAGO] â†’ [FINAL]
```

---

## ğŸ“ ETAPA 1: AUTENTICACIÃ“N (AuthController)

### 1.1 REGISTRO DE USUARIO
```
POST /api/auth/register
Body: {
  "nombre_usuario": "juan_perez",
  "correo_electronico": "juan@example.com",
  "contrasena": "SecurePass123",
  "nombre_rol": "cliente"  // Opcional, por defecto es "cliente"
}

Response (201): {
  "success": true,
  "message": "Usuario registrado exitosamente",
  "data": {
    "id_usuario": 5,
    "nombre_usuario": "juan_perez",
    "correo_electronico": "juan@example.com",
    "id_rol": 2,
    "nombre_rol": "cliente",
    "token": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9..."
  }
}
```

**Guardar el token en localStorage:**
```javascript
localStorage.setItem('token', response.data.token);
localStorage.setItem('userId', response.data.id_usuario);
```

---

### 1.2 LOGIN
```
POST /api/auth/login
Body: {
  "correo_electronico": "juan@example.com",
  "contrasena": "SecurePass123"
}

Response (200): {
  "success": true,
  "message": "Login exitoso",
  "data": {
    "id_usuario": 5,
    "nombre_usuario": "juan_perez",
    "correo_electronico": "juan@example.com",
    "id_rol": 2,
    "nombre_rol": "cliente",
    "permisos": { /* permisos del rol */ },
    "token": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9..."
  }
}
```

**Importante:** En TODAS las siguientes peticiones, incluye el header:
```
Authorization: Bearer {token}
```

---

### 1.3 OBTENER PERFIL (Requiere Auth)
```
GET /api/auth/profile
Headers: { "Authorization": "Bearer {token}" }

Response (200): {
  "success": true,
  "message": "OperaciÃ³n exitosa",
  "data": {
    "id_usuario": 5,
    "nombre_usuario": "juan_perez",
    "correo_electronico": "juan@example.com",
    "rol": {
      "id_rol": 2,
      "nombre_rol": "cliente",
      "descripcion": "Usuario cliente",
      "permisos": { /* permisos */ }
    },
    "fecha_creacion": "2025-11-05T10:30:00.000Z"
  }
}
```

---

### 1.4 ACTUALIZAR PERFIL (Requiere Auth)
```
PUT /api/auth/profile
Headers: { "Authorization": "Bearer {token}" }
Body: {
  "nombre_usuario": "nuevo_nombre"
  // NO PUEDES cambiar: correo_electronico, rol
}

Response (200): { "success": true, "message": "Perfil actualizado..." }
```

---

### 1.5 CAMBIAR CONTRASEÃ‘A (Requiere Auth)
```
PUT /api/auth/change-password
Headers: { "Authorization": "Bearer {token}" }
Body: {
  "contrasena_actual": "SecurePass123",
  "contrasena_nueva": "NewSecurePass456"
}

Response (204): Sin contenido (actualizaciÃ³n exitosa)
```

---

## ğŸ“ ETAPA 2: GESTIÃ“N DE PERFIL CLIENTE (ClienteController)

### 2.1 OBTENER MI PERFIL DE CLIENTE (Requiere Auth)
```
GET /api/clientes/perfil
Headers: { "Authorization": "Bearer {token}" }

Response (200): {
  "success": true,
  "data": {
    "id_cliente": 3,
    "id_usuario": 5,
    "nombre": "Juan",
    "apellido": "PÃ©rez",
    "telefono": "555-1234",
    "fecha_registro": "2025-11-05T10:30:00.000Z"
  }
}
```

### 2.2 CREAR PERFIL DE CLIENTE (Requiere Auth)
```
POST /api/clientes
Headers: { "Authorization": "Bearer {token}" }
Body: {
  "nombre": "Juan",
  "apellido": "PÃ©rez",
  "telefono": "555-1234"
}

Response (201): { "success": true, "data": { ...perfil creado... } }
```

### 2.3 ACTUALIZAR PERFIL DE CLIENTE (Requiere Auth)
```
PUT /api/clientes/:id
Headers: { "Authorization": "Bearer {token}" }
Body: {
  "nombre": "Juan Carlos",
  "apellido": "PÃ©rez GarcÃ­a",
  "telefono": "555-5678"
}

Response (200): { "success": true, "data": { ...perfil actualizado... } }
```

---

## ğŸ“ ETAPA 3: GESTIÃ“N DE DIRECCIONES (DireccionController)

### 3.1 LISTAR MIS DIRECCIONES (Requiere Auth)
```
GET /api/direcciones
Headers: { "Authorization": "Bearer {token}" }

Response (200): {
  "success": true,
  "data": [
    {
      "id_direccion": 1,
      "calle": "Calle Principal 123",
      "ciudad": "Madrid",
      "codigo_postal": "28001",
      "pais": "EspaÃ±a",
      "es_principal": true
    },
    { ...mÃ¡s direcciones... }
  ]
}
```

### 3.2 CREAR DIRECCIÃ“N (Requiere Auth)
```
POST /api/direcciones
Headers: { "Authorization": "Bearer {token}" }
Body: {
  "calle": "Calle Principal 123",
  "ciudad": "Madrid",
  "codigo_postal": "28001",
  "pais": "EspaÃ±a",
  "es_principal": false
}

Response (201): { "success": true, "data": { ...direcciÃ³n creada... } }
```

### 3.3 ACTUALIZAR DIRECCIÃ“N (Requiere Auth)
```
PUT /api/direcciones/:id
Headers: { "Authorization": "Bearer {token}" }
Body: { ...datos a actualizar... }

Response (200): { "success": true, "data": { ...direcciÃ³n actualizada... } }
```

### 3.4 ELIMINAR DIRECCIÃ“N (Requiere Auth)
```
DELETE /api/direcciones/:id
Headers: { "Authorization": "Bearer {token}" }

Response (204): Sin contenido (eliminaciÃ³n exitosa)
```

---

## ğŸ“ ETAPA 4: GESTIÃ“N DE PRODUCTOS (ProductoController)

### 4.1 LISTAR PRODUCTOS (PÃºblico - Sin Auth)
```
GET /api/productos
Query params (opcional):
  - ?categoria={id_categoria}
  - ?minprecio={num}
  - ?maxprecio={num}

Response (200): {
  "success": true,
  "data": [
    {
      "id_producto": 1,
      "nombre": "Laptop Gaming",
      "descripcion": "Laptop de alto rendimiento",
      "precio": 1200.00,
      "stock": 5,
      "imagenes": [
        {
          "id_imagen": 1,
          "url": "http://..../imagen1.jpg",
          "es_principal": true
        }
      ],
      "categoria": {
        "id_categoria": 2,
        "nombre_categoria": "ElectrÃ³nica"
      }
    },
    { ...mÃ¡s productos... }
  ]
}
```

### 4.2 OBTENER UN PRODUCTO (PÃºblico - Sin Auth)
```
GET /api/productos/:id

Response (200): { "success": true, "data": { ...detalles producto... } }
```

### 4.3 LISTAR CATEGORÃAS (PÃºblico - Sin Auth)
```
GET /api/categorias

Response (200): {
  "success": true,
  "data": [
    {
      "id_categoria": 1,
      "nombre_categoria": "Ropa",
      "descripcion": "Ropa y accesorios"
    },
    { ...mÃ¡s categorÃ­as... }
  ]
}
```

---

## ğŸ“ ETAPA 5: GESTIÃ“N DEL CARRITO (CarritoController)

### 5.1 OBTENER MI CARRITO (Requiere Auth)
```
GET /api/carrito
Headers: { "Authorization": "Bearer {token}" }

Response (200): {
  "success": true,
  "data": {
    "id_carrito": 5,
    "id_cliente": 3,
    "estado": "activo",
    "productosCarrito": [
      {
        "id_carrito_producto": 10,
        "cantidad": 2,
        "precio_unitario": 1200.00,
        "subtotal": 2400.00,
        "producto": {
          "id_producto": 1,
          "nombre": "Laptop Gaming",
          "precio": 1200.00
        }
      },
      { ...mÃ¡s productos en carrito... }
    ],
    "total": 2400.00
  }
}
```

### 5.2 AGREGAR PRODUCTO AL CARRITO (Requiere Auth)
```
POST /api/carrito
Headers: { "Authorization": "Bearer {token}" }
Body: {
  "id_producto": 1,
  "cantidad": 2
}

Response (201): { "success": true, "data": { ...producto agregado... } }
```

### 5.3 ACTUALIZAR CANTIDAD EN CARRITO (Requiere Auth)
```
PUT /api/carrito/:id_producto
Headers: { "Authorization": "Bearer {token}" }
Body: {
  "cantidad": 5  // Nueva cantidad
}

Response (200): { "success": true, "data": { ...actualizado... } }
```

### 5.4 ELIMINAR PRODUCTO DEL CARRITO (Requiere Auth)
```
DELETE /api/carrito/:id_producto
Headers: { "Authorization": "Bearer {token}" }

Response (204): Sin contenido (eliminaciÃ³n exitosa)
```

### 5.5 VACIAR CARRITO (Requiere Auth)
```
DELETE /api/carrito/clear
Headers: { "Authorization": "Bearer {token}" }

Response (204): Sin contenido
```

---

## ğŸ“ ETAPA 6: CREACIÃ“N DE Ã“RDENES (OrdenController)

### 6.1 CREAR ORDEN DESDE CARRITO (Requiere Auth)
```
POST /api/ordenes
Headers: { "Authorization": "Bearer {token}" }
Body: {
  "id_direccion": 1,
  "notas": "Enviar entre 10am y 6pm"  // Opcional
}

Response (201): {
  "success": true,
  "data": {
    "id_orden": 15,
    "numero_orden": "ORD-2025-00015",
    "id_cliente": 3,
    "estado_orden": "pendiente",
    "direccion": { ...datos direcciÃ³n... },
    "items": [
      {
        "id_item": 20,
        "id_producto": 1,
        "nombre_producto": "Laptop Gaming",
        "cantidad": 2,
        "precio_unitario": 1200.00,
        "subtotal": 2400.00
      }
    ],
    "total": 2400.00,
    "fecha_creacion": "2025-11-05T14:30:00.000Z"
  }
}
```

**âš ï¸ Importante:** 
- El carrito se vacÃ­a automÃ¡ticamente despuÃ©s de crear la orden
- La orden comienza con estado "pendiente"
- Todos los productos deben tener stock suficiente

### 6.2 LISTAR MIS Ã“RDENES (Requiere Auth)
```
GET /api/ordenes
Headers: { "Authorization": "Bearer {token}" }

Response (200): {
  "success": true,
  "data": [
    {
      "id_orden": 15,
      "numero_orden": "ORD-2025-00015",
      "estado_orden": "completada",
      "total": 2400.00,
      "fecha_creacion": "2025-11-05T14:30:00.000Z"
    },
    { ...mÃ¡s Ã³rdenes... }
  ]
}
```

### 6.3 OBTENER DETALLES DE UNA ORDEN (Requiere Auth)
```
GET /api/ordenes/:id
Headers: { "Authorization": "Bearer {token}" }

Response (200): {
  "success": true,
  "data": {
    "id_orden": 15,
    "numero_orden": "ORD-2025-00015",
    "estado_orden": "pendiente",
    "items": [ ...items detallados... ],
    "direccion": { ...datos envÃ­o... },
    "total": 2400.00,
    "pagos": [
      {
        "id_pago": 8,
        "monto": 2400.00,
        "metodo_pago": "tarjeta_credito",
        "estado_pago": "pendiente",
        "fecha": "2025-11-05T14:31:00.000Z"
      }
    ],
    "fecha_creacion": "2025-11-05T14:30:00.000Z"
  }
}
```

---

## ğŸ“ ETAPA 7: PROCESAMIENTO DE PAGOS (PaymentController)

### 7.1 CREAR PAGO (Requiere Auth)
```
POST /api/ordenes/:id_orden/pagos
Headers: { "Authorization": "Bearer {token}" }
Body: {
  "monto": 2400.00,
  "metodo_pago": "tarjeta_credito",  // "tarjeta_credito" | "transferencia" | "efectivo"
  "referencia_pago": "TXN-123456789"
}

Response (201): {
  "success": true,
  "data": {
    "id_pago": 8,
    "id_orden": 15,
    "monto": 2400.00,
    "metodo_pago": "tarjeta_credito",
    "estado_pago": "pendiente",
    "fecha_creacion": "2025-11-05T14:31:00.000Z"
  }
}
```

### 7.2 LISTAR PAGOS DE UNA ORDEN (Requiere Auth)
```
GET /api/ordenes/:id_orden/pagos
Headers: { "Authorization": "Bearer {token}" }

Response (200): {
  "success": true,
  "data": [
    {
      "id_pago": 8,
      "monto": 2400.00,
      "metodo_pago": "tarjeta_credito",
      "estado_pago": "completado",
      "fecha_creacion": "2025-11-05T14:31:00.000Z"
    }
  ]
}
```

### 7.3 OBTENER DETALLES DE UN PAGO (Requiere Auth)
```
GET /api/ordenes/:id_orden/pagos/:id_pago
Headers: { "Authorization": "Bearer {token}" }

Response (200): {
  "success": true,
  "data": { ...detalles pago... }
}
```

---

## ğŸ“Š FLUJO DE DATOS ENTRE TABLAS
```
USUARIOS
   â†“ (1 usuario = 1 cliente)
CLIENTES â† DIRECCIONES (1 cliente puede tener mÃºltiples direcciones)
   â†“ (1 cliente = 1 carrito activo)
CARRITO_COMPRAS â† CARRITO_PRODUCTOS â† PRODUCTOS â† CATEGORIAS
   â†“
Ã“RDENES â† ORDEN_ITEMS â† PRODUCTOS
   â†“
PAGOS
```

---

## ğŸ”’ ROLES Y PERMISOS
```
Rol: CLIENTE (id_rol: 2) [Defecto para nuevos usuarios]
- Ver productos
- Gestionar perfil
- Gestionar carrito
- Crear Ã³rdenes
- Crear pagos

Rol: ADMINISTRADOR (id_rol: 1)
- CRUD de productos
- CRUD de categorÃ­as
- CRUD de imÃ¡genes
- Gestionar estado de Ã³rdenes
- Gestionar estado de pagos
```

---

## âŒ MANEJO DE ERRORES ESTÃNDAR

Todos los errores siguen este formato:

```javascript
{
  "success": false,
  "error": {
    "code": "VALIDATION_ERROR" | "NOT_FOUND" | "UNAUTHORIZED" | "FORBIDDEN" | "INTERNAL_ERROR",
    "message": "DescripciÃ³n del error",
    "statusCode": 400 | 401 | 403 | 404 | 500
  }
}
```

**Ejemplos comunes:**

| Caso | Status | CÃ³digo |
|------|--------|--------|
| Token invÃ¡lido/expirado | 401 | UNAUTHORIZED |
| Sin permisos | 403 | FORBIDDEN |
| Recurso no encontrado | 404 | NOT_FOUND |
| Datos invÃ¡lidos | 400 | VALIDATION_ERROR |
| Error servidor | 500 | INTERNAL_ERROR |

---

## ï¿½ FLUJOS DETALLADOS DE CADA CONTROLADOR

### FLUJO 1: AuthController (AutenticaciÃ³n)
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   USUARIO   â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
       â”‚ Inicia registro/login
       â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   AuthController         â”‚
â”‚ â€¢ register()             â”‚
â”‚ â€¢ login()                â”‚
â”‚ â€¢ getProfile()           â”‚
â”‚ â€¢ updateProfile()        â”‚
â”‚ â€¢ changePassword()       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â”‚ Valida datos y llama service
           â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   UserService            â”‚
â”‚ â€¢ createUser()           â”‚
â”‚ â€¢ getUserById()          â”‚
â”‚ â€¢ getUserByEmail()       â”‚
â”‚ â€¢ updateUser()           â”‚
â”‚ â€¢ disableUser()          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â”‚ Ejecuta queries SQL
           â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   BD (PostgreSQL)        â”‚
â”‚   Tabla: Usuarios        â”‚
â”‚   Tabla: Roles           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â”‚ Retorna datos
           â†‘
       [TOKEN JWT]
   (Guardado en localStorage)
```

**Pasos clave:**
1. Frontend envÃ­a credenciales
2. Controller valida formato
3. Service busca/crea usuario en BD
4. Se genera JWT si es Ã©xito
5. Frontend guarda token para futuras requests

---

### FLUJO 2: ClienteController (GestiÃ³n de Perfil Cliente)
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   USUARIO   â”‚ (Autenticado con token)
â”‚ (Token)     â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
       â”‚ GET/POST/PUT /api/clientes
       â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   ClienteController      â”‚
â”‚ â€¢ getPerfil()            â”‚
â”‚ â€¢ crearPerfil()          â”‚
â”‚ â€¢ actualizarPerfil()     â”‚
â”‚ â€¢ obtenerCliente()       â”‚ (solo admin)
â”‚ â€¢ eliminarCliente()      â”‚ (solo admin)
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â”‚ Valida token + permisos
           â”‚ Llama service
           â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   ClienteService         â”‚
â”‚ â€¢ getClientByUserId()    â”‚
â”‚ â€¢ createClient()         â”‚
â”‚ â€¢ updateClient()         â”‚
â”‚ â€¢ deleteClient()         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â”‚ Ejecuta queries SQL
           â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   BD (PostgreSQL)        â”‚
â”‚   Tabla: Clientes        â”‚
â”‚   Tabla: Usuarios        â”‚ (relaciÃ³n 1:1)
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â”‚ Retorna datos cliente
           â†‘
      Respuesta JSON
```

**Flujo especÃ­fico GET /api/clientes/perfil:**
1. Middleware verifica token â†’ extrae id_usuario
2. ClienteController llama service
3. Service busca cliente donde id_usuario = {id_usuario}
4. Retorna perfil del cliente (nombre, apellido, telÃ©fono, etc.)

---

### FLUJO 3: ProductoController (CatÃ¡logo de Productos)
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   USUARIO   â”‚ (No requiere autenticaciÃ³n para listar)
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
       â”‚ GET /api/productos
       â”‚ GET /api/productos/:id
       â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   ProductoController     â”‚
â”‚ â€¢ listarProductos()      â”‚ (pÃºblico)
â”‚ â€¢ obtenerProducto()      â”‚ (pÃºblico)
â”‚ â€¢ crearProducto()        â”‚ (solo admin)
â”‚ â€¢ actualizarProducto()   â”‚ (solo admin)
â”‚ â€¢ eliminarProducto()     â”‚ (solo admin)
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â”‚ Valida (permisos si es POST/PUT/DELETE)
           â”‚ Llama service
           â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   ProductoService        â”‚
â”‚ â€¢ getAll()               â”‚
â”‚ â€¢ getById()              â”‚
â”‚ â€¢ create()               â”‚
â”‚ â€¢ update()               â”‚
â”‚ â€¢ delete()               â”‚
â”‚ â€¢ getByCategory()        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â”‚ Ejecuta queries SQL
           â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   BD (PostgreSQL)        â”‚
â”‚   Tabla: Productos       â”‚
â”‚   Tabla: Categorias      â”‚ (FK)
â”‚   Tabla: ProductoImagenesâ”‚ (1:N)
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â”‚ Retorna array de productos
           â†‘
      Respuesta JSON
```

**Ejemplo GET /api/productos?categoria=2&minprecio=100&maxprecio=5000:**
1. No necesita token
2. Controller recibe query params
3. Service construye WHERE con filtros
4. BD retorna productos que coincidan

---

### FLUJO 4: CarritoController (Carrito de Compras) â­
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   USUARIO   â”‚ (REQUIERE AUTENTICACIÃ“N)
â”‚ (Token)     â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
       â”‚ GET /api/carrito (ver carrito)
       â”‚ POST /api/carrito (agregar producto)
       â”‚ PUT /api/carrito/:id_producto (cambiar cantidad)
       â”‚ DELETE /api/carrito/:id_producto (quitar)
       â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   CarritoController      â”‚
â”‚ â€¢ obtenerCarrito()       â”‚
â”‚ â€¢ agregarProducto()      â”‚
â”‚ â€¢ actualizarCantidad()   â”‚
â”‚ â€¢ eliminarProducto()     â”‚
â”‚ â€¢ vaciarCarrito()        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â”‚ Valida token â†’ obtiene id_usuario
           â”‚ Llama service
           â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   ClienteService         â”‚
â”‚ â€¢ getClientByUserId()    â”‚ (obtiene id_cliente)
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â”‚
           â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   CarritoService         â”‚
â”‚ â€¢ obtenerCarritoActivo() â”‚
â”‚ â€¢ agregarProducto()      â”‚
â”‚ â€¢ actualizarCantidad()   â”‚
â”‚ â€¢ eliminarProducto()     â”‚
â”‚ â€¢ calcularTotal()        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â”‚ Valida:
           â”‚ - Producto existe
           â”‚ - Stock disponible
           â”‚ - Carrito existe o crear nuevo
           â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   BD (PostgreSQL)        â”‚
â”‚   Tabla: CarritoCompras  â”‚
â”‚   Tabla: CarritoProductosâ”‚
â”‚   Tabla: Productos       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â”‚ Retorna carrito actualizado
           â†‘
      Respuesta JSON con:
      - ID carrito
      - Lista de items
      - Subtotal de cada item
      - Total carrito
```

**Ejemplo POST /api/carrito (agregar producto):**
```
USUARIO â†’ Controller recibe {id_producto: 5, cantidad: 2}
        â†’ Valida token (obtiene id_usuario)
        â†’ Llama ClienteService.getClientByUserId(id_usuario)
        â†’ Obtiene id_cliente
        â†’ Llama CarritoService.obtenerCarritoActivo(id_cliente)
        â†’ Si no existe carrito â†’ crea uno nuevo
        â†’ Valida stock: ProductoService.verificarStock(id_producto, 2)
        â†’ Si stock OK â†’ agrega a tabla CarritoProductos
        â†’ Calcula total
        â†’ Retorna carrito actualizado
```

**Estados del carrito:**
- `activo` â†’ usuario aÃºn estÃ¡ comprando
- `completado` â†’ orden creada, carrito archivado

---

### FLUJO 5: DireccionController (Direcciones de EnvÃ­o)
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   USUARIO   â”‚ (REQUIERE AUTENTICACIÃ“N)
â”‚ (Token)     â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
       â”‚ GET /api/direcciones
       â”‚ POST /api/direcciones (crear nueva)
       â”‚ PUT /api/direcciones/:id (editar)
       â”‚ DELETE /api/direcciones/:id (borrar)
       â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   DireccionController    â”‚
â”‚ â€¢ listarDirecciones()    â”‚
â”‚ â€¢ crearDireccion()       â”‚
â”‚ â€¢ actualizarDireccion()  â”‚
â”‚ â€¢ eliminarDireccion()    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â”‚ Valida token â†’ obtiene id_usuario
           â”‚ Busca id_cliente
           â”‚ Llama service
           â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   DireccionService       â”‚
â”‚ â€¢ getByCliente()         â”‚
â”‚ â€¢ create()               â”‚
â”‚ â€¢ update()               â”‚
â”‚ â€¢ delete()               â”‚
â”‚ â€¢ setMasPrincipal()      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â”‚ Valida:
           â”‚ - Datos direcciÃ³n vÃ¡lidos
           â”‚ - Solo propias direcciones
           â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   BD (PostgreSQL)        â”‚
â”‚   Tabla: Direcciones     â”‚
â”‚   Tabla: Clientes        â”‚ (FK)
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â”‚ Retorna direcciÃ³n/s
           â†‘
      Respuesta JSON
```

**Datos de una direcciÃ³n:**
- Calle, nÃºmero, apartamento
- Ciudad, cÃ³digo postal
- PaÃ­s
- TelÃ©fono (opcional)
- Es principal (boolean)

---

### FLUJO 6: OrdenController (Crear Ã“rdenes)
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   USUARIO   â”‚ (REQUIERE AUTENTICACIÃ“N)
â”‚ (Token)     â”‚ (Tiene carrito con items)
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
       â”‚ POST /api/ordenes
       â”‚ {id_direccion: 1, notas: "..."}
       â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   OrdenController        â”‚
â”‚ â€¢ crearOrden()           â”‚
â”‚ â€¢ listarOrdenes()        â”‚
â”‚ â€¢ obtenerOrden()         â”‚
â”‚ â€¢ actualizarEstado()     â”‚ (solo admin)
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â”‚ Valida token â†’ id_usuario
           â”‚ Inicia TRANSACCIÃ“N
           â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   ClienteService         â”‚
â”‚ â€¢ getClientByUserId()    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â”‚ Obtiene id_cliente
           â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   CarritoService         â”‚
â”‚ â€¢ obtenerCarritoActivo() â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â”‚ Obtiene items en carrito
           â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   DireccionService       â”‚
â”‚ â€¢ getDireccionById()     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â”‚ Valida direcciÃ³n existe y pertenece al usuario
           â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   OrdenService           â”‚
â”‚ â€¢ create()               â”‚
â”‚ â€¢ createItems()          â”‚
â”‚ â€¢ calcularTotal()        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â”‚ Para cada item:
           â”‚ 1. Verifica stock actual
           â”‚ 2. Descuenta stock
           â”‚ 3. Crea orden_item
           â”‚ 4. Calcula subtotal
           â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   BD (PostgreSQL)        â”‚
â”‚   Tabla: Ordenes         â”‚
â”‚   Tabla: OrdenItems      â”‚
â”‚   Tabla: Productos       â”‚
â”‚   (Stock se actualiza)   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â”‚ Marca carrito como "completado"
           â”‚ Confirma TRANSACCIÃ“N
           â†‘
      Respuesta JSON:
      - numero_orden (ej: ORD-2025-00015)
      - items de la orden
      - total
      - estado: "pendiente"
```

**Validaciones crÃ­ticas:**
1. âœ… Usuario autenticado
2. âœ… Carrito no vacÃ­o
3. âœ… DirecciÃ³n existe y pertenece al usuario
4. âœ… Stock suficiente para TODOS los items
5. âœ… Si falla algo â†’ ROLLBACK (no se crea nada)

---

### FLUJO 7: PaymentController (Procesamiento de Pagos)
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   USUARIO   â”‚ (REQUIERE AUTENTICACIÃ“N)
â”‚ (Token)     â”‚ (Tiene orden con estado "pendiente")
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
       â”‚ POST /api/ordenes/:id_orden/pagos
       â”‚ {monto, metodo_pago, referencia_pago}
       â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   PaymentController      â”‚
â”‚ â€¢ crearPago()            â”‚
â”‚ â€¢ listarPagos()          â”‚
â”‚ â€¢ obtenerPago()          â”‚
â”‚ â€¢ actualizarEstado()     â”‚ (solo admin)
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â”‚ Valida token
           â”‚ Inicia TRANSACCIÃ“N
           â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   OrdenService           â”‚
â”‚ â€¢ getOrdenById()         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â”‚ Valida:
           â”‚ - Orden existe
           â”‚ - Pertenece al usuario
           â”‚ - Estado es "pendiente"
           â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   PaymentService         â”‚
â”‚ â€¢ create()               â”‚
â”‚ â€¢ validarMonto()         â”‚
â”‚ â€¢ procesarPago()         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â”‚ Valida:
           â”‚ 1. Monto = total orden
           â”‚ 2. MÃ©todo pago vÃ¡lido
           â”‚ 3. IntegraciÃ³n con gateway (si existe)
           â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   BD (PostgreSQL)        â”‚
â”‚   Tabla: Pagos           â”‚
â”‚   Tabla: Ordenes         â”‚
â”‚   (Estado se actualiza)  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â”‚ Crea pago con estado "completado"
           â”‚ Actualiza estado orden a "confirmada"
           â”‚ Confirma TRANSACCIÃ“N
           â†‘
      Respuesta JSON:
      - id_pago
      - monto confirmado
      - metodo_pago
      - estado: "completado"
      - fecha pago
```

**MÃ©todos de pago soportados:**
- `tarjeta_credito` â†’ integraciÃ³n con gateway (futuro)
- `transferencia` â†’ validaciÃ³n manual
- `efectivo` â†’ requiere confirmaciÃ³n admin

**Estados del pago:**
- `pendiente` â†’ creado pero no confirmado
- `completado` â†’ pago exitoso
- `cancelado` â†’ pago rechazado

---

## ï¿½ğŸ’¡ TIPS PARA EL FRONTEND

1. **Guardar token despuÃ©s de login:**
   ```javascript
   localStorage.setItem('token', response.data.token);
   ```

2. **Usar token en todas las peticiones autenticadas:**
   ```javascript
   headers: { "Authorization": `Bearer ${localStorage.getItem('token')}` }
   ```

3. **Validar stock antes de comprar:**
   - Verificar `producto.stock > 0` antes de agregar al carrito

4. **Mostrar total del carrito:**
   - Sumar: `item.cantidad * item.precio_unitario` para cada item

5. **Estados de orden:** pendiente â†’ confirmada â†’ enviada â†’ completada

6. **Estados de pago:** pendiente â†’ completado â†’ cancelado

---

## ğŸ“ RESUMEN - QUÃ‰ HACE CADA CONTROLADOR

| Controlador | FunciÃ³n Principal | Requiere Auth |
|---|---|---|
| **AuthController** | Registro, Login, Perfil, Cambio Password | Parcial |
| **ClienteController** | Gestionar perfil cliente (asociado a usuario) | âœ… SÃ­ |
| **ProductoController** | CRUD productos (admin) y listar (todos) | Parcial |
| **CarritoController** | Agregar/remover productos, ver carrito | âœ… SÃ­ |
| **DireccionController** | Gestionar direcciones de envÃ­o | âœ… SÃ­ |
| **OrdenController** | Crear Ã³rdenes desde carrito, ver mis Ã³rdenes | âœ… SÃ­ |
| **PaymentController** | Procesar pagos, actualizar estados | âœ… SÃ­ |

---